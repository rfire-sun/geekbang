## 启动节点

```
[root@localhost redis]# pwd
/Users/suncheng/redis
[root@localhost redis]# redis-server redis6379/redis6379.conf 
[root@localhost redis]# redis-server redis6380/redis6380.conf 
[root@localhost redis]# redis-server redis6381/redis6381.conf 
```

## 主从配置

```
[root@localhost ~]# redis-cli -p 6380
127.0.0.1:6380> SLAVEOF 127.0.0.1 6379
OK
127.0.0.1:6380> 
[root@localhost ~]# redis-cli -p 6381
127.0.0.1:6381> SLAVEOF 127.0.0.1 6379
OK
```

## 验证主从节点

```
[root@localhost ~]# redis-cli -p 6379
127.0.0.1:6379> set kk vv
OK
[root@localhost ~]# redis-cli -p 6380
127.0.0.1:6381> get kk
"vv"
127.0.0.1:6381> set kk dd
(error) READONLY You can't write against a read only replica.
```

从节点会同步主节点的key，无法写（set），只能读（get）



## 启动哨兵

```
[root@localhost sentinel1]# redis-sentinel sentinel1.conf
[root@localhost sentinel0]# redis-sentinel sentinel0.conf
```

相关日志

```
733c73d14d
19193:X 29 May 2022 07:09:13.500 # +monitor master mymaster 127.0.0.1 6379 quorum 2
19193:X 29 May 2022 07:09:13.517 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
19193:X 29 May 2022 07:09:13.558 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
19193:X 29 May 2022 07:09:13.862 * +sentinel sentinel 8d992c54df8f8677b0b345825f61fb733c73d14c 127.0.0.1 26379 @ mymaster 127.0.0.1 6379
```

```
19012:X 29 May 2022 07:08:06.146 # Sentinel ID is 8d992c54df8f8677b0b345825f61fb733c73d14c
19012:X 29 May 2022 07:08:06.146 # +monitor master mymaster 127.0.0.1 6379 quorum 2
19012:X 29 May 2022 07:08:06.154 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:08:06.173 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:09:15.556 * +sentinel sentinel 8d992c54df8f8677b0b345825f61fb733c73d14d 127.0.0.1 26380 @ mymaster 127.0.0.1 6379
```

## 验证主节点下线fail over

直接结束teminator

哨兵选举日志

可以看到选取了81为新的主

```
19012:X 29 May 2022 07:11:57.585 # +try-failover master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:57.607 # +vote-for-leader 8d992c54df8f8677b0b345825f61fb733c73d14c 1
19012:X 29 May 2022 07:11:57.654 # 8d992c54df8f8677b0b345825f61fb733c73d14d voted for 8d992c54df8f8677b0b345825f61fb733c73d14c 1
19012:X 29 May 2022 07:11:57.676 # +elected-leader master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:57.677 # +failover-state-select-slave master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:57.773 # +selected-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:57.774 * +failover-state-send-slaveof-noone slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:57.832 * +failover-state-wait-promotion slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:58.338 # +promoted-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:58.338 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:58.428 * +slave-reconf-sent slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:58.774 # -odown master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:59.416 * +slave-reconf-inprog slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:59.417 * +slave-reconf-done slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:59.483 # +failover-end master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:59.484 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6381
19012:X 29 May 2022 07:11:59.486 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381
19012:X 29 May 2022 07:11:59.486 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381
19012:X 29 May 2022 07:12:09.501 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381
```

哨兵配置文件改变

```
sentinel myid 8d992c54df8f8677b0b345825f61fb733c73d14c
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 127.0.0.1 6381 2
sentinel down-after-milliseconds mymaster 10000
# Generated by CONFIG REWRITE
protected-mode no
port 26379
# user default on nopass sanitize-payload ~* &* +@all
user default on nopass ~* +@all
dir "/Users/kimmking/kimmking/JavaCourseCodes/08cache/ha/conf"

sentinel config-epoch mymaster 1
sentinel leader-epoch mymaster 1
sentinel known-replica mymaster 127.0.0.1 6379
sentinel known-replica mymaster 127.0.0.1 6380
sentinel known-sentinel mymaster 127.0.0.1 26380 8d992c54df8f8677b0b345825f61fb733c73d14d
sentinel current-epoch 1
```

可在新的master进行写操作

```
127.0.0.1:6381> set kk vv
OK
```

## 宕机节点重新上线

`[root@localhost redis]# redis-server redis6379/redis6379.conf `

哨兵有日志出现，将旧主变为了新从

```
 29 May 2022 07:11:59.483 # +failover-end master mymaster 127.0.0.1 6379
19012:X 29 May 2022 07:11:59.484 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6381
19012:X 29 May 2022 07:11:59.486 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381
19012:X 29 May 2022 07:11:59.486 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381
19012:X 29 May 2022 07:12:09.501 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381
19012:X 29 May 2022 07:18:43.416 # -sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6381

```

可以看到旧主是slave状态，对应新的主6381
```
127.0.0.1:6379> info

...
eplication
role:slave
master_host:127.0.0.1
master_port:6381
master_link_status:up

```

旧主无法进行写操作

```
127.0.0.1:6379> set kjk sdfdf
(error) READONLY You can't write against a read only replica.
127.0.0.1:6379> 
```

